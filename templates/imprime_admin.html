<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impresión Prepago - Usuario</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Control de Impresión Prepago</h2>

    <div class="mb-3">
      <label for="rut" class="form-label">Ingrese RUT</label>
      <input
        type="text"
        class="form-control"
        id="rut"
        placeholder="Ej: 12345678-9"
      />
    </div>
    <button class="btn btn-success mb-3" onclick="consultarUsuario()">
      Consultar
    </button>

    <div id="datosUsuario" style="display: none;">
      <p>
        <strong>Nombre:</strong> <span id="nombreUsuario"></span>
      </p>
      <p>
        <strong>Saldo Páginas:</strong> <span id="saldoPaginas"></span>
      </p>

      <div class="mb-3">
        <label for="paginas" class="form-label">Cantidad de Páginas a Imprimir</label>
        <input type="number" class="form-control" id="paginas" min="1" />
      </div>

      <div class="mb-3">
        <label for="concepto" class="form-label">Concepto</label>
        <input
          type="text"
          class="form-control"
          id="concepto"
          placeholder="Ej: Impresión de informe"
        />
      </div>

      <button class="btn btn-primary" onclick="confirmarImpresion()">
        OK
      </button>
    </div>

    <div id="mensaje" class="mt-4"></div>
  </div>

  <script>
    // Cambia aquí por la URL donde está tu backend desplegado
    const backendUrl = "https://prepago.onrender.com";

    async function consultarUsuario() {
      const rut = document.getElementById("rut").value.trim();
      if (!rut) {
        mostrarMensaje("Por favor, ingresa un RUT válido.", "danger");
        return;
      }

      try {
        const respuesta = await fetch(`${backendUrl}/consultar`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rut }),
        });

        const datos = await respuesta.json();
        const mensaje = document.getElementById("mensaje");
        mensaje.innerHTML = "";

        if (respuesta.ok) {
          document.getElementById("nombreUsuario").textContent = datos.nombre;
          document.getElementById("saldoPaginas").textContent = datos.saldo;
          document.getElementById("datosUsuario").style.display = "block";
        } else {
          document.getElementById("datosUsuario").style.display = "none";
          mostrarMensaje(datos.error, "danger");
        }
      } catch (error) {
        mostrarMensaje("Error al conectar con el servidor.", "danger");
      }
    }

    function confirmarImpresion() {
      const paginas = parseInt(document.getElementById("paginas").value);
      const saldo = parseInt(document.getElementById("saldoPaginas").textContent);

      if (isNaN(paginas) || paginas < 1) {
        mostrarMensaje("Ingrese una cantidad válida de páginas.", "danger");
        return;
      }

      if (paginas > saldo) {
        mostrarMensaje("Saldo insuficiente.", "danger");
        return;
      }

      const nuevoSaldo = saldo - paginas;
      document.getElementById("saldoPaginas").textContent = nuevoSaldo;
      mostrarMensaje(
        `Impresión confirmada. Nuevo saldo: ${nuevoSaldo} páginas.`,
        "success"
      );

      // Aquí podrías agregar código para enviar la actualización al backend
    }

    function mostrarMensaje(texto, tipo) {
      const mensaje = document.getElementById("mensaje");
      mensaje.innerHTML = `<div class="alert alert-${tipo}">${texto}</div>`;
    }
  </script>
</body>
</html>
