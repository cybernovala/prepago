<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Impresiones</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f2f2f2;
      padding: 20px;
    }
    .container {
      max-width: 480px;
      margin: auto;
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    .whatsapp-btn {
      background-color: #25D366;
      color: white;
      border: none;
    }
    .whatsapp-btn:hover {
      background-color: #1ebc59;
    }
  </style>
</head>
<body>

  <div class="container text-center">
    <h4 class="mb-4">Consulta de Saldo</h4>

    <div class="mb-3">
      <input type="text" id="rutInput" class="form-control" placeholder="Ingresa tu RUT sin puntos ni guion">
    </div>
    <button onclick="consultarRut()" class="btn btn-primary w-100">Consultar</button>

    <div id="resultado" class="mt-4" style="display: none;">
      <p><strong>Nombre:</strong> <span id="nombre"></span></p>
      <p><strong>Saldo disponible:</strong> <span id="saldo"></span> p치ginas</p>
      <button id="btnWhatsapp" class="btn whatsapp-btn w-100 mt-3">
        Solicitar impresi칩n por WhatsApp
      </button>
    </div>

    <div id="error" class="alert alert-danger mt-3" style="display: none;"></div>
  </div>

  <script>
    let rutGlobal = '';

    window.addEventListener('DOMContentLoaded', () => {
      const rutGuardado = localStorage.getItem('rut');
      if (rutGuardado) {
        document.getElementById('rutInput').value = rutGuardado;
        // Opcional: lanzar consulta autom치ticamente al recargar
        // consultarRut();
      }
    });

    async function consultarRut() {
      const rutInput = document.getElementById('rutInput');
      const rut = rutInput.value.trim();
      const resultadoDiv = document.getElementById('resultado');
      const errorDiv = document.getElementById('error');

      resultadoDiv.style.display = 'none';
      errorDiv.style.display = 'none';

      if (!rut) {
        errorDiv.textContent = 'Por favor ingresa un RUT.';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('https://prepago.onrender.com/consultar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rut })
        });

        const data = await response.json();

        if (response.ok) {
          rutGlobal = rut;
          localStorage.setItem('rut', rut);

          document.getElementById('nombre').textContent = data.nombre;
          document.getElementById('saldo').textContent = data.saldo;
          resultadoDiv.style.display = 'block';

          document.getElementById('btnWhatsapp').onclick = () => {
            const mensaje = `Hola, soy ${data.nombre} (RUT: ${rutGlobal}). Quiero solicitar una impresi칩n desde la app.`;
            const telefonoAdmin = '56966648585';
            const url = `https://wa.me/${telefonoAdmin}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
          };

        } else {
          errorDiv.textContent = data.error || 'Error al consultar el RUT.';
          errorDiv.style.display = 'block';
        }

      } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'No se pudo conectar al servidor.';
        errorDiv.style.display = 'block';
      }
    }

  </script>
</body>
</html>
