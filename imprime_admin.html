<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Impresión Prepago</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Control de Impresión Prepago</h2>

    <div class="mb-3">
      <label for="rut" class="form-label">Ingrese RUT</label>
      <input type="text" class="form-control" id="rut" placeholder="Ej: 12345678-9">
    </div>
    <button class="btn btn-success mb-3" onclick="consultarUsuario()">Consultar</button>

    <div id="datosUsuario" style="display: none;">
      <p><strong>Nombre:</strong> <span id="nombreUsuario"></span></p>
      <p><strong>Saldo Páginas:</strong> <span id="saldoPaginas"></span></p>

      <div class="mb-3">
        <label for="paginas" class="form-label">Cantidad de Páginas a Imprimir</label>
        <input type="number" class="form-control" id="paginas" min="1">
      </div>

      <div class="mb-3">
        <label for="concepto" class="form-label">Concepto</label>
        <input type="text" class="form-control" id="concepto" placeholder="Ej: Impresión de informe">
      </div>

      <button class="btn btn-primary" onclick="confirmarImpresion()">OK</button>
    </div>

    <div id="mensaje" class="mt-4"></div>
  </div>

  <script>
    const backendUrl = "https://prepago-backend.onrender.com"; // <-- Cambiar según tu URL

    async function consultarUsuario() {
      const rut = document.getElementById("rut").value;
      const respuesta = await fetch(`${backendUrl}/consulta/${rut}`);
      const datos = await respuesta.json();

      const mensaje = document.getElementById("mensaje");
      mensaje.innerHTML = "";

      if (respuesta.ok) {
        document.getElementById("nombreUsuario").textContent = datos.nombre;
        document.getElementById("saldoPaginas").textContent = datos.saldo;
        document.getElementById("datosUsuario").style.display = "block";
      } else {
        document.getElementById("datosUsuario").style.display = "none";
        mensaje.innerHTML = `<div class="alert alert-danger">${datos.error}</div>`;
      }
    }

    function confirmarImpresion() {
      const paginas = parseInt(document.getElementById("paginas").value);
      const saldo = parseInt(document.getElementById("saldoPaginas").textContent);

      const mensaje = document.getElementById("mensaje");

      if (paginas > saldo) {
        mensaje.innerHTML = '<div class="alert alert-danger">Saldo insuficiente</div>';
      } else {
        const nuevoSaldo = saldo - paginas;
        document.getElementById("saldoPaginas").textContent = nuevoSaldo;
        mensaje.innerHTML = `<div class="alert alert-success">Impresión confirmada. Nuevo saldo: ${nuevoSaldo} páginas</div>`;
        // Aquí podrías enviar los cambios al backend
      }
    }
  </script>
</body>
</html>
